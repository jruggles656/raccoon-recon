{{define "title"}}Dashboard{{end}}
{{define "content"}}
<div class="page-header">
    <h2>Dashboard</h2>
</div>

<div class="dashboard-banner"> ____                                  ____
|  _ \ __ _  ___ ___ ___   ___  _ __ |  _ \ ___  ___ ___  _ __
| |_) / _` |/ __/ __/ _ \ / _ \| '_ \| |_) / _ \/ __/ _ \| '_ \
|  _ &lt; (_| | (_| (_| (_) | (_) | | | |  _ &lt;  __/ (_| (_) | | | |
|_| \_\__,_|\___\___\___/ \___/|_| |_|_| \_\___|\___\___/|_| |_|</div>

<div class="card-grid">
    <div class="card">
        <h3>Projects</h3>
        <p class="stat" id="stat-projects">0</p>
        <a href="/projects" class="btn btn-sm">View Projects</a>
    </div>
    <div class="card">
        <h3>Total Scans</h3>
        <p class="stat" id="stat-scans">0</p>
    </div>
    <div class="card">
        <h3>Findings</h3>
        <p class="stat" id="stat-findings">0</p>
    </div>
</div>

<div class="scan-line"></div>

<p class="section-header">Quick Actions</p>
<div class="quick-actions-grid">
    <div class="quick-action-card">
        <h4>WHOIS Lookup</h4>
        <p class="qa-desc">Query domain registration info</p>
        <div class="qa-form">
            <input type="text" id="qa-whois-target" placeholder="example.com">
            <button onclick="quickScan('whois', 'qa-whois-target', 'passive')">Run</button>
        </div>
    </div>

    <div class="quick-action-card">
        <h4>DNS Records</h4>
        <p class="qa-desc">Fetch DNS records via dig</p>
        <div class="qa-form">
            <input type="text" id="qa-dig-target" placeholder="example.com">
            <button onclick="quickScan('dig', 'qa-dig-target', 'passive')">Run</button>
        </div>
    </div>

    <div class="quick-action-card">
        <h4>Port Scan</h4>
        <p class="qa-desc">Quick TCP scan via nmap</p>
        <div class="qa-form">
            <input type="text" id="qa-nmap-target" placeholder="192.168.1.1">
            <button onclick="quickScan('nmap', 'qa-nmap-target', 'active')">Run</button>
        </div>
    </div>

    <div class="quick-action-card">
        <h4>SSL/TLS Check</h4>
        <p class="qa-desc">Analyze certificate and TLS config</p>
        <div class="qa-form">
            <input type="text" id="qa-ssl-target" placeholder="example.com">
            <button onclick="quickScan('ssl_check', 'qa-ssl-target', 'web')">Run</button>
        </div>
    </div>

    <div class="quick-action-card">
        <h4>Metadata Extractor</h4>
        <p class="qa-desc">Extract HTTP headers, meta tags, OG data</p>
        <div class="qa-form">
            <input type="text" id="qa-meta-target" placeholder="https://example.com">
            <button onclick="quickScan('metadata_extract', 'qa-meta-target', 'web')">Run</button>
        </div>
    </div>

    <div class="quick-action-card">
        <h4>Google Dorking</h4>
        <p class="qa-desc">Generate targeted search queries</p>
        <div class="qa-form">
            <input type="text" id="qa-dork-target" placeholder="example.com">
            <button onclick="quickScan('google_dorking', 'qa-dork-target', 'passive')">Run</button>
        </div>
    </div>

    <div class="quick-action-card">
        <h4>File Metadata</h4>
        <p class="qa-desc">Extract EXIF, PDF info, and hidden data from files</p>
        <div class="file-drop-zone" id="file-drop-zone"
             onclick="document.getElementById('file-input').click()"
             ondragover="event.preventDefault(); this.classList.add('dragover')"
             ondragleave="this.classList.remove('dragover')"
             ondrop="event.preventDefault(); this.classList.remove('dragover'); uploadFileMetadata(event.dataTransfer.files[0])">
            <span class="drop-label">Drop image or PDF here, or click to browse</span>
        </div>
        <input type="file" id="file-input" accept="image/*,.pdf" style="display:none"
               onchange="if(this.files[0]) uploadFileMetadata(this.files[0]); this.value='';">
    </div>
</div>

<div id="qa-modal" class="qa-output-modal hidden">
    <div class="qa-output-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h3 id="qa-modal-title" style="font-size:14px; font-family:var(--font-mono); color:var(--text-primary);">Scan Output</h3>
            <button class="btn btn-sm" onclick="closeQAModal()">Close</button>
        </div>
        <span id="qa-scan-status" class="badge badge-running">Running</span>
        <img id="qa-image-preview" src="" alt="Preview">
        <div id="qa-terminal" class="terminal" style="margin-top:12px;"></div>
        <div id="qa-results" style="display:none; margin-top:12px;">
            <table class="data-table">
                <thead><tr><th>Type</th><th>Key</th><th>Value</th></tr></thead>
                <tbody id="qa-results-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="card">
    <h3>Tool Status</h3>
    <div id="tool-status-grid" class="tool-status-grid">
        <p class="empty-state">Loading tool status...</p>
    </div>
</div>

<div class="card">
    <h3>Recent Scans</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Target</th>
                <th>Tool</th>
                <th>Type</th>
                <th>Status</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="recent-scans-body">
            <tr>
                <td colspan="5" class="empty-state">No scans yet. Use the quick actions above or visit a recon module.</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
async function initDashboard() {
    const statsResp = await fetch('/api/stats');
    if (statsResp.ok) {
        const stats = await statsResp.json();
        document.getElementById('stat-projects').textContent = stats.project_count || 0;
        document.getElementById('stat-scans').textContent = stats.scan_count || 0;
        document.getElementById('stat-findings').textContent = stats.result_count || 0;
    }

    const toolResp = await fetch('/api/tools/status');
    if (toolResp.ok) {
        const tools = await toolResp.json();
        const grid = document.getElementById('tool-status-grid');
        if (tools && tools.length > 0) {
            grid.innerHTML = tools.map(t => `
                <div class="tool-status-item ${t.installed ? 'installed' : 'missing'}">
                    <span class="tool-indicator"></span>
                    <span class="tool-name">${esc(t.name)}</span>
                    <span class="tool-version">${t.installed ? esc(t.version || 'found') : 'not found'}</span>
                </div>
            `).join('');
        } else {
            grid.innerHTML = '<p class="empty-state">No tools configured.</p>';
        }
    }

    const scansResp = await fetch('/api/scans/recent');
    if (scansResp.ok) {
        const scans = await scansResp.json();
        const tbody = document.getElementById('recent-scans-body');
        if (scans && scans.length > 0) {
            tbody.innerHTML = scans.map(s => `<tr>
                <td style="font-family: var(--font-mono);">${esc(s.target)}</td>
                <td>${esc(s.tool)}</td>
                <td>${esc(s.scan_type)}</td>
                <td><span class="badge badge-${s.status}">${esc(s.status)}</span></td>
                <td>${new Date(s.started_at).toLocaleString()}</td>
            </tr>`).join('');
        }
    }
}

initDashboard();
</script>
{{end}}

{{define "title"}}Results{{end}}
{{define "content"}}
<div class="page-header">
    <h2>Results</h2>
</div>

<div class="card">
    <div class="form-row" style="margin-bottom: 16px;">
        <div class="form-group" style="flex:1; margin-bottom:0;">
            <label for="results-project">Project</label>
            <select id="results-project" onchange="loadAllResults()">
                <option value="0">All Projects</option>
            </select>
        </div>
        <div class="form-group" style="flex:1; margin-bottom:0;">
            <label for="results-type-filter">Type Filter</label>
            <select id="results-type-filter" onchange="filterResults()">
                <option value="">All Types</option>
                <option value="port">Ports</option>
                <option value="dns">DNS Records</option>
                <option value="whois">WHOIS</option>
                <option value="header">HTTP Headers</option>
                <option value="ssl">SSL/TLS</option>
                <option value="os">OS Detection</option>
                <option value="google_dork">Google Dorks</option>
                <option value="osint_link">OSINT Links</option>
                <option value="raw">Raw Output</option>
            </select>
        </div>
        <div class="form-group" style="flex:2; margin-bottom:0;">
            <label for="results-search">Search</label>
            <input type="text" id="results-search" placeholder="Filter results..." oninput="filterResults()">
        </div>
    </div>

    <div id="results-count" style="color: var(--text-muted); font-size: 12px; margin-bottom: 8px;"></div>

    <table class="data-table" id="all-results-table">
        <thead>
            <tr>
                <th style="cursor:pointer;" onclick="sortResults('result_type')">Type</th>
                <th style="cursor:pointer;" onclick="sortResults('key')">Key</th>
                <th style="cursor:pointer;" onclick="sortResults('value')">Value</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="all-results-body">
            <tr><td colspan="4" class="empty-state">Select a project or run scans to see results.</td></tr>
        </tbody>
    </table>
</div>

<script>
let allResults = [];
let currentSort = { field: '', asc: true };

async function loadAllResults() {
    const projectId = document.getElementById('results-project').value;
    let url = '/api/scans/recent';
    if (projectId && projectId !== '0') {
        url = `/api/projects/${projectId}/results`;
    }

    const resp = await fetch(url);
    if (!resp.ok) return;

    if (projectId && projectId !== '0') {
        allResults = await resp.json() || [];
    } else {
        // For "all projects", we need to get all results
        const projects = await (await fetch('/api/projects')).json() || [];
        allResults = [];
        for (const p of projects) {
            const r = await (await fetch(`/api/projects/${p.id}/results`)).json() || [];
            allResults = allResults.concat(r);
        }
    }

    filterResults();
}

function filterResults() {
    const typeFilter = document.getElementById('results-type-filter').value;
    const search = document.getElementById('results-search').value.toLowerCase();

    let filtered = allResults;
    if (typeFilter) {
        filtered = filtered.filter(r => r.result_type === typeFilter);
    }
    if (search) {
        filtered = filtered.filter(r =>
            r.key.toLowerCase().includes(search) ||
            r.value.toLowerCase().includes(search) ||
            r.result_type.toLowerCase().includes(search)
        );
    }

    if (currentSort.field) {
        filtered.sort((a, b) => {
            const va = (a[currentSort.field] || '').toLowerCase();
            const vb = (b[currentSort.field] || '').toLowerCase();
            return currentSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
        });
    }

    renderResults(filtered);
}

function sortResults(field) {
    if (currentSort.field === field) {
        currentSort.asc = !currentSort.asc;
    } else {
        currentSort = { field, asc: true };
    }
    filterResults();
}

function renderResults(results) {
    const tbody = document.getElementById('all-results-body');
    const countEl = document.getElementById('results-count');
    countEl.textContent = `${results.length} result${results.length !== 1 ? 's' : ''}`;

    if (results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No results match your filters.</td></tr>';
        return;
    }

    tbody.innerHTML = results.map(r => {
        let displayValue = r.value;
        if (displayValue.startsWith('http://') || displayValue.startsWith('https://')) {
            displayValue = `<a href="${esc(r.value)}" target="_blank" rel="noopener" style="color: var(--accent);">${esc(r.value)}</a>`;
        } else {
            displayValue = esc(displayValue);
        }
        return `<tr>
            <td><span class="badge badge-${badgeClass(r.result_type)}">${esc(r.result_type)}</span></td>
            <td style="font-family: var(--font-mono);">${esc(r.key)}</td>
            <td>${displayValue}</td>
            <td style="font-size:11px; color: var(--text-muted);">${esc(r.details || '')}</td>
        </tr>`;
    }).join('');
}

// Load projects into dropdown and then results
(async function() {
    const sel = document.getElementById('results-project');
    const resp = await fetch('/api/projects');
    if (resp.ok) {
        const projects = await resp.json();
        if (projects) {
            projects.forEach(p => {
                sel.innerHTML += `<option value="${p.id}">${esc(p.name)}</option>`;
            });
        }
    }
    loadAllResults();
})();
</script>
{{end}}
